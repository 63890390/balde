/**
 * balde: A microframework for C based on GLib and bad intentions.
 * Copyright (C) 2013 Rafael G. Martins <rafael@rafaelmartins.eng.br>
 *
 * This program can be distributed under the terms of the LGPL-2 License.
 * See the file COPYING.
 */

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif /* HAVE_CONFIG_H */


/**
 * balde-template-gen is a damn simple code generator, that converts an HTML
 * template to C source, that should be compiled and linked to the balde app.
 *
 * This isn't easy to use but is really fast, and this is what matters! :P
 *
 * Usage: $ balde-template-gen template.html foo
 *
 * This will generate foo.c and foo.h. You should add both files to the
 * foo_SOURCES variable in your Makefile.am file, and include foo.h in your
 * app source.
 *
 * Also, you may want to add a rule to rebuild your foo.c and foo.h files
 * when you change the template.
 */

#include <glib.h>
#include <stdlib.h>


gchar*
generate_source(const gchar *template_basename, const gchar *template_source)
{
    gchar *escaped_source = g_strescape(template_source, "");
    gchar *rv = g_strdup_printf(
        "// WARNING: this file was generated automatically by balde-template-gen\n"
        "\n"
        "#include <balde.h>\n"
        "#include <glib.h>\n"
        "#include <stdarg.h>\n"
        "\n"
        "void\n"
        "balde_template_%s(balde_response_t *response, ...)\n"
        "{\n"
        "    va_list args;\n"
        "    va_start(args, response);\n"
        "    gchar *rv = g_strdup_vprintf(\"%s\", args);\n"
        "    balde_response_append_body(response, rv);\n"
        "    g_free(rv);\n"
        "    va_end(args);\n"
        "}\n", template_basename, escaped_source);
    g_free(escaped_source);
    return rv;
}


gchar*
generate_header(const gchar *template_basename)
{
    return g_strdup_printf(
        "// WARNING: this file was generated automatically by balde-template-gen\n"
        "\n"
        "#ifndef __%s_balde_template\n"
        "#define __%s_balde_template\n"
        "\n"
        "#include <balde.h>\n"
        "\n"
        "void balde_template_%s(balde_response_t *response, ...);\n"
        "\n"
        "#endif\n", template_basename, template_basename, template_basename);
}


gchar*
get_template_name(const gchar *template_basename)
{
    gchar *template_name = g_path_get_basename(template_basename);
    for (guint i = 0; template_name[i] != '\0'; i++) {
        if (!g_ascii_isalpha(template_name[i])) {
            template_name[i] = '_';
        }
    }
    return template_name;
}


int
main(int argc, char **argv)
{
    int rv = EXIT_SUCCESS;
    if (argc != 3) {
        g_printerr("Usage: $ balde-template-gen template.html foo\n");
        rv = EXIT_FAILURE;
        goto point1;
    }
    gchar *template_name = get_template_name(argv[2]);
    gchar *template_source = NULL;
    if (!g_file_get_contents(argv[1], &template_source, NULL, NULL)) {
        g_printerr("Failed to read source file: %s\n", argv[1]);
        rv = EXIT_FAILURE;
        goto point2;
    }
    gchar *c_filename = g_strdup_printf("%s.c", argv[2]);
    gchar *c_source = generate_source(template_name, template_source);
    if (!g_file_set_contents(c_filename, c_source, -1, NULL)) {
        g_printerr("Failed to write C source file: %s\n", c_filename);
        rv = EXIT_FAILURE;
        goto point3;
    }
    gchar *h_filename = g_strdup_printf("%s.h", argv[2]);
    gchar *h_source = generate_header(template_name);
    if (!g_file_set_contents(h_filename, h_source, -1, NULL)) {
        g_printerr("Failed to write C header file: %s\n", h_filename);
        rv = EXIT_FAILURE;
    }
    g_free(h_filename);
    g_free(h_source);
point3:
    g_free(c_filename);
    g_free(c_source);
    g_free(template_source);
point2:
    g_free(template_name);
point1:
    return rv;
}
