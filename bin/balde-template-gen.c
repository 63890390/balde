/*
 * balde: A microframework for C based on GLib and bad intentions.
 * Copyright (C) 2013 Rafael G. Martins <rafael@rafaelmartins.eng.br>
 *
 * This program can be distributed under the terms of the LGPL-2 License.
 * See the file COPYING.
 */

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif /* HAVE_CONFIG_H */


/*
 * balde-template-gen is a damn simple code generator, that converts an HTML
 * template to C source, that should be compiled and linked to the balde app.
 *
 * This isn't easy to use but is really fast, and this is what matters! :P
 *
 * Usage: $ balde-template-gen template.html template.[ch]
 *
 * This will generate template.c or template.h. You should add both files to
 * the foo_SOURCES variable in your Makefile.am file, and include template.h
 * in your app source.
 *
 * Also, you may want to add a rule to rebuild your template.c and template.h
 * files when you change template.html.
 */

#include <glib.h>
#include <stdlib.h>
#include <string.h>


gchar*
generate_source(const gchar *template_name, const gchar *template_source)
{
    gchar *escaped_source = g_strescape(template_source, "");
    gchar *rv = g_strdup_printf(
        "// WARNING: this file was generated automatically by balde-template-gen\n"
        "\n"
        "#include <balde.h>\n"
        "#include <glib.h>\n"
        "#include <stdarg.h>\n"
        "\n"
        "const gchar *balde_template_%s_format = \"%s\";\n"
        "\n"
        "void\n"
        "balde_template_%s(balde_response_t *response, ...)\n"
        "{\n"
        "    va_list args;\n"
        "    va_start(args, response);\n"
        "    gchar *rv = g_strdup_vprintf(balde_template_%s_format, args);\n"
        "    balde_response_append_body(response, rv);\n"
        "    g_free(rv);\n"
        "    va_end(args);\n"
        "}\n", template_name, escaped_source, template_name, template_name);
    g_free(escaped_source);
    return rv;
}


gchar*
generate_header(const gchar *template_name)
{
    return g_strdup_printf(
        "// WARNING: this file was generated automatically by balde-template-gen\n"
        "\n"
        "#ifndef __%s_balde_template\n"
        "#define __%s_balde_template\n"
        "\n"
        "#include <balde.h>\n"
        "\n"
        "const gchar *balde_template_%s_format;\n"
        "void balde_template_%s(balde_response_t *response, ...);\n"
        "\n"
        "#endif\n", template_name, template_name, template_name, template_name);
}


gchar*
get_template_name(const gchar *template_basename)
{
    gchar *template_name = g_path_get_basename(template_basename);
    for (guint i = strlen(template_name) + 1; i != 0; i--) {
        if (template_name[i] == '.') {
            template_name[i] = '\0';
            break;
        }
    }
    for (guint i = 0; template_name[i] != '\0'; i++) {
        if (!g_ascii_isalpha(template_name[i])) {
            template_name[i] = '_';
        }
    }
    return template_name;
}


int
main(int argc, char **argv)
{
    int rv = EXIT_SUCCESS;
    if (argc != 3) {
        g_printerr("Usage: $ balde-template-gen template.html template.[ch]\n");
        rv = EXIT_FAILURE;
        goto point1;
    }
    gchar *template_name = get_template_name(argv[2]);
    gchar *template_source = NULL;
    gchar *source = NULL;
    if (g_str_has_suffix(argv[2], ".c")) {
        if (!g_file_get_contents(argv[1], &template_source, NULL, NULL)) {
            g_printerr("Failed to read source file: %s\n", argv[1]);
            rv = EXIT_FAILURE;
            goto point2;
        }
        source = generate_source(template_name, template_source);
    }
    else if (g_str_has_suffix(argv[2], ".h")) {
        source = generate_header(template_name);
    }
    else {
        g_printerr("Invalid filename: %s\n", argv[2]);
        rv = EXIT_FAILURE;
        goto point3;
    }
    if (!g_file_set_contents(argv[2], source, -1, NULL)) {
        g_printerr("Failed to write file: %s\n", argv[2]);
        rv = EXIT_FAILURE;
        goto point3;  // duh!
    }
point3:
    if (source != NULL)
        g_free(source);
    if (template_source != NULL)
        g_free(template_source);
point2:
    if (template_name != NULL)
        g_free(template_name);
point1:
    return rv;
}
